<!doctype html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CWIT Norm Calculator</title>
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous"> -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

  <style media="screen">
    .calc {
      padding: 25px;
    }

    .measures {
      margin-bottom: 25px;
    }

    footer {
      background-color: #0A2D3A;
      color: #fff;
      margin-top: 25px;
    }

  </style>  

</head>

<body class="bg-light">
  <div class="container">
    <div class="py-4 text-center">

      <h2>CWIT Norm Calculator</h2>

    </div>

    <div class="border rounded">

      <form class="calc" action="#" id="calc">
        <div class="measures">
          <!-- Demographics -->
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Age</label>
            <div class="col-sm-4 col-4">
              <input type="number" class="form-control form-control-sm" name="age" id="age" min="20" max="85" placeholder="20 - 85" required />
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Years of education</label>
            <div class="col-sm-4">
              <input type="number" class="form-control form-control-sm" name="edu" id="edu" min="7" max="23" placeholder="7 - 23" required>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-2 col-form-label">Sex</label>
            <div class="col-sm-4">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sex" id="radio-male" value="0" checked>
                <label class="form-check-label">
                  Male
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sex" id="radio-female" value="1">
                <label class="form-check-label">
                  Female
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <div class="col-sm-10 measures">
            <button type="submit" class="btn btn-primary">Calculate</button>
          </div>
        </div>


        <div class="measures">
          <h5>Main measures</h5>
          <div class="form-group row">
            <div class="col-sm-1 col-3">
            </div>
            <label class="col-sm-2 col-3 col-form-label">Raw score</label>
            <label class="col-sm-2 col-3 col-form-label">Z-Score</label>
            <label class="col-sm-2 col-3 col-form-label">T-Score</label>
          </div>

          <div class="form-group row">
            <label class="col-sm-1 col-3 col-form-label">CWIT 1</label>
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm raw" data-cwit="cwit1" id="raw-cwit1">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm zscore" id="z-score-cwit1" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm tscore" id="t-score-cwit1" tabindex="-1" readonly>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-1 col-3 col-form-label">CWIT 2</label>
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm raw" id="raw-cwit2" data-cwit="cwit2">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm zscore" id="z-score-cwit2" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm tscore" id="t-score-cwit2" tabindex="-1" readonly>
            </div>
          </div>

          <div class="form-group row">
            <label class="col-sm-1 col-3 col-form-label">CWIT 3</label>
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm raw" id="raw-cwit3" data-cwit="cwit3">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm zscore" id="z-score-cwit3" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm tscore" id="t-score-cwit3" tabindex="-1" readonly>
            </div>
            
          </div>
          <div class="form-group row">
            <label class="col-sm-1 col-3 col-form-label">CWIT 4</label>
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm raw" id="raw-cwit4" data-cwit="cwit4">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm zscore" id="z-score-cwit4" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm tscore" id="t-score-cwit4" tabindex="-1" readonly>
            </div>
            
          </div>
        </div>

        <div class="measures" id="error-container">
          <h5>Errors</h5>
          <div class="form-group row">
            <div class="col-sm-1 col-3">
            </div>
            <label class="col-sm-2 col-3 col-form-label">No. of errors</label>
            <label class="col-sm-2 col-3 col-form-label">Cumulative %</label>
          </div>
          <div class="form-group row">
            <label class="col-sm-1 col-3 col-form-label">CWIT 3</label>
            
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm error" id="error-cwit3">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm" id="percentage-cwit3" tabindex="-1" readonly>
            </div>
          </div>
          <div class="form-group row">
            <label class="col-sm-1 col-3 col-form-label">CWIT 4</label>
            
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm error" id="error-cwit4">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm" id="percentage-cwit4" tabindex="-1" readonly>
            </div>
          </div>
        </div>

        <div class="measures" id="derived-measures">
          <h5>Derived measures</h5>

          <div class="form-group row">
            <label class="col-sm-1 col-1 col-form-label text-muted">Adj. by</label>
            <label class="col-sm-2 col-4 col-form-label">CWIT 1</label>
            <label class="col-sm-2 col-4 col-form-label">CWIT 2</label>
            <label class="col-sm-2 col-4 col-form-label">CWIT 1&2</label>
            <label class="col-sm-2 col-4 col-form-label">CWIT 3</label>
          </div>

          <div class="form-group row">
            <label class="col-sm-1 col-3 col-form-label">CWIT 3</label>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm derived" id="cwit3-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm derived" id="cwit3-2" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm derived" id="cwit3-1-2" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3"></div>
          </div>

          <div class="form-group row">
            <label class="col-sm-1 col-3 col-form-label">CWIT 4</label>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm derived" id="cwit4-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm derived" id="cwit4-2" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm derived" id="cwit4-1-2" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm derived" id="cwit4-3" tabindex="-1" readonly>
            </div>
            
          </div>

        </div>


      </form>
  
      
    
    </div>

    <div class="border rounded" style="margin-top: 20px;">
      <form id="fileForm" class="calc">
        <div class="measures">
          <h5>Bulk processing</h5> <i class="fa-regular fa-circle-question"></i>
          
          <div>
            <p class="text-secondary">Process multiple test results stored in a comma separated file (CSV). Use <a id="download-link" href="#">this template</a> to follow the expected format.</p>
          </div>
          
          
          <div class="form-group row">
            <label class="form-label">CSV data file</label>
            <div class="col-sm-6 col-3">
              <input class="form-control" type="file" id="dataFile">
            </div>
          </div>

          <div class="form-group row" style="margin-top: 10px;">
            <div class="col-sm-10">
              <button type="submit" class="btn btn-primary" value="Process file">
                <span id="spinner" class="spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
                Process file
              </button>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>
  <footer class="d-flex flex-wrap justify-content-between align-items-center py-3">
    <!-- <div class="container"> -->

        <p class="col-md-4 mb-0"></p>
        <!-- col-md-4 col -->
        <div class="col-md-4 col-sm-12">
          <p class="text-light"><small>Created by the Dementia Disease Initiation (DDI) project; No guarantee or liability implied.<br>
            Supplement of <em>Espenes et al (2023). Regression‐based normative data for the D-KEFS Color-Word Interference Test in Norwegian adults ages 20 to 85.</em></small></p>
        </div>
        <p class="col-md-4 mb-0"></p>

    <!-- </div>     -->
  </footer>

  <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" charset="utf-8"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
  <script type="text/javascript">

    $('#calc').submit(function(event) {
      // prevent default action
      event.preventDefault();
      calculate();
      return false;
    });

    const t_score_min = 20;
    const t_score_max = 80;
    const mean_age = 46.165183;
    const mean_edu = 15.456973;

    class CWITTest{
      constructor (testName, intercept, coefs, sd, scalingTable, percentageTable, derived) {
        this.testName = testName;
        this.intercept = intercept;
        this.sd = sd;
        this.coefs = coefs;
        this.scalingTable = scalingTable;
        this.percentageTable = percentageTable;
        this.derived = derived;
      }

      /**
       * This function a escaling entry and a rawValue and returns true if the rawValue is in the range of the entry
       * @param {Array} entry - an array of two elements, the first is the range and the second is the value to return if the rawValue is in the range
       * @param {Number} rawValue - the raw value to be evaluated
       * @return {Boolean} - true if the rawValue is in the range of the entry
       */
      evaluateScalingEntry(entry, rawValue){
        if (typeof entry[0] === 'number') {
          return rawValue == entry[0];
        } else if (typeof entry[0] === 'string'){
          var test = entry[0];
          // if there is a - in the string then it is a range
          if (test.indexOf('-') > -1) {
            var range = test.split('-');
            return rawValue >= range[0] && rawValue <= range[1];
          } 
          // if there is a '>=' in the string then it is the upper cutoff
          else if (test.indexOf('>=') > -1) {
            var top = test.split('>=')[1];
            return rawValue >= top;
          }
          // if there is a '<=' in the string then it is the lower cutoff
          else if (test.indexOf('<=') > -1) {
            var bottom = test.split('<=')[1];
            return rawValue <= bottom;
          }
        }
      }

      /**
       * This function takes in a raw value and returns the scaled value
       * 
       * @param {number} rawValue - the raw value to be scaled
       * @param {array} scalingTable - the scaling table to use
       * @returns {number} - the scaled value
       */
      scaleValue(value) {
        // Find the index of the input value in the lookup table
        var i = 0;
        while (i < this.scalingTable.length - 1 && !this.evaluateScalingEntry(this.scalingTable[i], value)) {
          i++;
        }
        var scaled = this.scalingTable[i][1];
        return scaled;
      }

      calculateScores(age, edu, sex, test_raw){
        var age_centered = age - mean_age;
        var age_centered_2 = age_centered * age_centered;
        var edu_centered = edu - mean_edu;

        var b_age = this.coefs.age;
        var b_age_2 = this.coefs.age2;
        var b_edu = this.coefs.edu;
        var b_sex = this.coefs.sex;

        // age coefficient is common to all tests
        var coefSum = (b_age * age_centered) + (b_age_2 * age_centered_2);
        // if edu in coefs is not undefined add to the sum
        if (b_edu) {
          coefSum += b_edu * edu_centered;
        }
        // if b_sex is not undefined add to the sum
        if (b_sex) {
          coefSum += b_sex * sex;
        }

        // final predicted score
        var scaled = this.scaleValue(test_raw, this.scalingTable);
        var predicted = this.intercept + coefSum;
        var cwit1Dif = scaled - predicted;
        var zscore = (scaled - predicted) / this.sd;
        var tscore = Math.max(t_score_min, Math.min(t_score_max, zscore * 10 + 50));

        return {
          'zscore' : zscore.toFixed(2),
          'tscore' : Math.round(tscore)          
        }
      }

      calculateDerivedDemographics(age, edu, sex, coefs){
        
        var age_centered = age - mean_age;
        var age_centered_2 = age_centered * age_centered;
        var edu_centered = edu - mean_edu;

        var b_age = coefs.age;
        var b_age_2 = coefs.age2;
        var b_edu = coefs.edu;
        var b_sex = coefs.sex;

        var coefSum = (b_age * age_centered) + (b_age_2 * age_centered_2) + (b_edu * edu_centered);      
        // if b_sex is not undefined add to the sum
        if (b_sex) {
          coefSum += b_sex * sex;
        }
        return coefSum;
      }

      calculateDerivedSingleTest(cwitObj, age, edu, sex, targetCoefs, test_adjust, test_raw){
        var coefSum = this.calculateDerivedDemographics(age, edu, sex, targetCoefs);
        var test_scaled = cwitObj.scaleValue(test_adjust);
        coefSum += test_scaled * targetCoefs.test;
        var scaled = this.scaleValue(test_raw);
        var predicted = targetCoefs.intercept + coefSum;
        var diff = scaled - predicted;
        var zscore = diff / targetCoefs.sd;
        var scaled_score = zscore * 3 + 10
        return Math.round(scaled_score);
      }

      calculateDerivedCombinedTest(cwitObj1, cwitObj2, age, edu, sex, targetCoefs, test_adjust_1, test_adjust_2, test_raw){
        var coefSum = this.calculateDerivedDemographics(age, edu, sex, targetCoefs);
        var test_1_scaled = cwitObj1.scaleValue(test_adjust_1);
        var test_2_scaled = cwitObj2.scaleValue(test_adjust_2);
        coefSum += test_1_scaled * targetCoefs.test_1;
        coefSum += test_2_scaled * targetCoefs.test_2;
        var scaled = this.scaleValue(test_raw);
        var predicted = targetCoefs.intercept + coefSum;
        var diff = scaled - predicted;
        var zscore = diff / targetCoefs.sd;
        var scaled_score = zscore * 3 + 10
        return Math.round(scaled_score);
      }

      calculateDerived(cwit1obj, cwit2obj, cwit3obj, age, edu, sex, cwit_1_raw, cwit_2_raw, cwit_3_raw, test_raw){
        var derives = {};
        test_raw = parseInt(test_raw);
        // calculate adjusted by CWIT_1
        if (cwit_1_raw !== ""){
          cwit_1_raw = parseInt(cwit_1_raw);
          var targetCoefs = this.derived.CWIT_1;
          var scaled_score = this.calculateDerivedSingleTest(cwit1obj, age, edu, sex, targetCoefs, cwit_1_raw, test_raw);
          derives.CWIT_1 = scaled_score;
        }
        // calculate adjusted by CWIT_2
        if (cwit_2_raw !== ""){
          cwit_2_raw = parseInt(cwit_2_raw);
          var targetCoefs = this.derived.CWIT_2;
          var scaled_score = this.calculateDerivedSingleTest(cwit2obj, age, edu, sex, targetCoefs, cwit_2_raw, test_raw);
          derives.CWIT_2 = scaled_score;
        }
        // calculate adjusted by CWIT_1 and CWIT_2
        if (cwit_1_raw !== "" && cwit_2_raw !== ""){
          cwit_1_raw = parseInt(cwit_1_raw);
          cwit_2_raw = parseInt(cwit_2_raw);
          var targetCoefs = this.derived.CWIT_1_2;
          var scale_score = this.calculateDerivedCombinedTest(cwit1obj, cwit2obj, age, edu, sex, targetCoefs, cwit_1_raw, cwit_2_raw, test_raw);
          derives.CWIT_1_2 = scale_score;
        }
        if (this.testName == "cwit4" && cwit_3_raw !== ""){
          cwit_3_raw = parseInt(cwit_3_raw);
          var targetCoefs = this.derived.CWIT_3;
          var scaled_score = this.calculateDerivedSingleTest(cwit3obj, age, edu, sex, targetCoefs, cwit_3_raw, test_raw);
          derives.CWIT_3 = scaled_score;
        }
        return derives;
      }

      get_percentage(errors){

        // if this.percentages is undefined return undefined
        if (!this.percentageTable) {
          return undefined;
        }

        var percentage = 100;
        var i = 0;

        while (i < this.percentageTable.length - 1 && errors != this.percentageTable[i][0]) {
          i++;
          percentage = this.percentageTable[i][1];
        }
        return percentage;
      }

    }

    // regression data structures
    var regression = {
      'mean_age' : 46.165183,
      'mean_edu' : 15.456973,
      'cwit1': {
        'intercept' :  9.863261,
        'demographic_coefs' : {
                            "age" :  -0.048884,
                            "age2" :  -0.001047,
                            "sex" :  0.824552
                          },
        "sd" :  2.774862,
        'scalingTable' : [
                          ['>=56', 1], //>= 56
                          ['48-55', 2],
                          ['46-47', 3],
                          ['42-45', 4],
                          ['40-41', 5],
                          ['37-39', 6],
                          ['35-36', 7],
                          ['33-34', 8],
                          ['31-32', 9],
                          ['29-30', 10],
                          ['27-28', 11],
                          [26, 12],
                          [25, 13],
                          ['23-24', 14],
                          [22, 15],
                          [21, 16],
                          [20, 17],
                          [19, 18],
                          ['<=18', 19], // <= 18
                        ]
      },

      'cwit2': {
        'intercept': 10.2171656,
        'demographic_coefs' : {
                                'age': -0.0185594,
                                "age2" :  -0.0009477
                              },
        'sd': 2.7966,
        'scalingTable' : [
                          ['>=52', 1], // ≥52
                          ['37-51', 2],
                          ['34-36', 3],
                          ['31-33', 4],
                          ['28-30', 5],
                          [27, 6],
                          ['25-26', 7],
                          [24, 8],
                          [23, 9],
                          ['21-22', 10],
                          [20, 11],
                          [19, 12],
                          [18, 13],
                          [17, 14],
                          [16, 15],
                          [15, 16],
                          ['<=14', 18], // ≤14
                        ]
      },

      'cwit3': {
        'intercept': 10.1824414,  
        'demographic_coefs' : {
                              'age': -0.0725760,  
                              'age2': -0.0012170,  
                              'sex': 0.4544109,
                              'edu': 0.0777976
                            },
        'sd': 2.545823, 
        'scalingTable' : [
                          ['>=130', 1], // ≥130
                          ['114-129', 2],
                          ['99-113', 3],
                          ['85-98', 4],
                          ['77-84', 5],
                          ['69-76', 6],
                          ['63-68', 7],
                          ['58-62', 8],
                          ['53-57', 9],
                          ['49-52', 10],
                          ['45-48', 11],
                          ['42-44', 12],
                          ['40-41', 13],
                          ['37-39', 14],
                          ['35-36', 15],
                          ['33-34', 16],
                          ['31-32', 17],
                          ['27-30', 18],
                          ['<=26', 19], // ≤26
                        ],
        'errors' : [
                    [0, 100],
                    [1, 51.4],
                    [2, 23.2],
                    [3, 11.1],
                    [4, 5.2],
                    [5, 2.8],
                    [6, 1.2],
                    [7, 0.5],
                    [8, 0.4],
                    [9, 0.2],
                    [10, 0.2],
                    [11, 0.1]
                  ],
        'derived' : {
                      'CWIT_1' : {
                        'intercept' : 3.28,
                        'age' : -0.045,
                        'age2' : -0.0006,
                        'edu': 0.089,
                        'test' : 0.559,
                        'sd' : 2.018
                      },
                      'CWIT_2' : { 
                        'intercept' : 4.69,
                        'age' : -0.065,
                        'age2' : -0.0008,
                        'edu' : 0.058,
                        'sex' : 0.367,
                        'test' : 0.458,
                        'sd' : 2.201
                      },
                      'CWIT_1_2' : {
                        'intercept' : 2.792,
                        'age' : -0.048,
                        'age2' : -0.0006,
                        'edu' : 0.079,
                        'test_1' : 0.448,
                        'test_2' : 0.177,
                        'sd' : 1.981
                      }
                    }
      },

      'cwit4': {
        'intercept': 10.5608373, 
        'demographic_coefs' : {
                              'age': -0.0629144,
                              'age2': -0.0015815,
                              'edu': 0.0981283
                            },
        'sd': 2.573627, 
        'scalingTable' : [
                          ['>=168', 1], 
                          ['133-167', 2],
                          ['117-132', 3],
                          ['101-116', 4],
                          ['88-100', 5],
                          ['78-87', 6],
                          ['71-77', 7],
                          ['65-70', 8],
                          ['60-64', 9],
                          ['55-59', 10],
                          ['51-54', 11],
                          ['48-50', 12],
                          ['45-47', 13],
                          ['42-44', 14],
                          ['39-41', 15],
                          ['37-38', 16],
                          ['34-36', 17],
                          ['31-33', 18],
                          ['<=30', 19], 
                        ],
        'errors' : [
                    [0, 100],
                    [1, 55.4],
                    [2, 26.5],
                    [3, 12.9],
                    [4, 6.3],
                    [5, 3.2],
                    [6, 1.5],
                    [7, 1.1],
                    [8, 0.6],
                    [9, 0.6],
                    [10, 0.6],
                    [11, 0.2]
                  ],
        'derived' : {
          'CWIT_1' : {
            'intercept' :	4.70,
            'age' :	-0.042,
            'age2' :	-0.001,
            'edu' : 	0.105,
            'test' :	0.410,
            'sd' : 2.31
          },
              
          'CWIT_2' : {
            'intercept' : 5.096,
            'age' :	-0.055,
            'age2' : -0.001,
            'edu' : 0.080,
            'test' : 0.416,
            'sd' : 2.297
          },

          'CWIT_1_2' : {
            'intercept' :	3.97,
            'age' :	-0.046,
            'age2' :	-0.001,
            'edu' : 	0.091,
            'test_1' :	0.240,
            'test_2' :	0.264,
            'sd' : 2.237
          },

          'CWIT_3' : {
            'intercept' :	4.46,
            'age' :	-0.018,
            'age2' :	-0.0008,
            'edu' : 	0.051,
            'test' :	0.602,
            'sd' : 2.064
          }
        }                
      },      
    }

    // instantiate CWITTest objects
    const cwit1Obj = new CWITTest('cwit1', regression.cwit1.intercept, regression.cwit1.demographic_coefs, regression.cwit1.sd, regression.cwit1.scalingTable);
    const cwit2Obj = new CWITTest('cwit2', regression.cwit2.intercept, regression.cwit2.demographic_coefs, regression.cwit2.sd, regression.cwit2.scalingTable);
    const cwit3Obj = new CWITTest('cwit3', regression.cwit3.intercept, regression.cwit3.demographic_coefs, regression.cwit3.sd, regression.cwit3.scalingTable, regression.cwit3.errors, regression.cwit3.derived);
    const cwit4Obj = new CWITTest('cwit4', regression.cwit4.intercept, regression.cwit4.demographic_coefs, regression.cwit4.sd, regression.cwit4.scalingTable, regression.cwit4.errors, regression.cwit4.derived);
    // create an object to hold all the CWITTest objects
    const cwitTests = {
      'cwit1': cwit1Obj,
      'cwit2': cwit2Obj,
      'cwit3': cwit3Obj,
      'cwit4': cwit4Obj
    }

    /**
     * Sets the tscore value to the element. If the tscore is 80 or 20, it adds the >= or <= sign to the value.
     * @param {object} element - the element to set the value to
     * @param {number} tscore - the tscore value
     */
    function set_tscore(element, tscore) {
      if (!Number.isNaN(tscore)) {
        // if tscore == 80 add >= to the value
        if (tscore == 80) {
          tscore = '≥ 80';
        }
        // if tscore == 20 add <= to the value
        if (tscore == 20) {
          tscore = '≤ 20';
        }
        $(element).val(tscore);
      } else {
        $(element).val('');
      }
    }

    function set_derived(element, derived){
      if (!Number.isNaN(derived)) {
        $(element).val(derived);
      } else {
        $(element).val('');
      }
    }

    /**
     * Calculates the errors for the CWIT3 and CWIT4 tests and sets the value to the element.
     */
    function calculate_errors(){
      tests = ['3', '4'];
      for(var i = 0; i < tests.length; i++){
        var test = tests[i];
        var cwitName = 'cwit' + test;
        var cwitObj = cwitTests[cwitName];
        // get the element value
        var elem = document.getElementById('error-cwit' + test);
        if (elem.value !== '') {
          var elemVal = parseInt(elem.value);
          var error = cwitObj.get_percentage(elemVal);
          $('#percentage-cwit' + test).val(error);
        }
      }
    }   

    function calculateDemographics(coefs, age, edu, sex){
      var age_centered = age - mean_age;
      var age_centered_2 = age_centered * age_centered;
      var edu_centered = edu - mean_edu;

      var b_age = coefs.age;
      var b_age_2 = coefs.age2;
      var b_edu = coefs.edu;
      var b_sex = coefs.sex;

      // age coefficient is common to all tests
      var coefSum = (b_age * age_centered) + (b_age_2 * age_centered_2) + (b_edu * edu_centered);
      // if edu in coefs is not undefined add to the sum
      if (b_edu) {
        coefSum += b_edu * edu_centered;
      }
      // if b_sex is not undefined add to the sum
      if (b_sex) {
        coefSum += b_sex * sex;
      }
    }

    /**
     * Calculates the derived measures for the CWIT3 and CWIT4 tests and sets the value to the element.
     */
    function calculateDerivedMeasures(age, edu, sex){
      derived_3 = regression.cwit3.derived;
      derived_4 = regression.cwit4.derived;
      var cwit_1 = document.getElementById('raw-cwit1');
      var cwit_2 = document.getElementById('raw-cwit2');
      var cwit_3 = document.getElementById('raw-cwit3');

      if (cwit_1.value !== ''){

      }

    }

    /**
     * For a given CWIT test, calculates the tscore and zscore and sets the values to the elements.
     * @param {number} age - the age value
     * @param {number} edu - the education value
     * @param {sex} sex - the sex value
     * @param {string} cwitName - the name of the CWIT test
     */
    function calculateTest(age, edu, sex, cwitName) {
      var cwit = document.getElementById('raw-' + cwitName);
      
      var cwitObj = cwitTests[cwitName];
      if (cwit.value !== ''){
        var cwitVal = parseInt(cwit.value);
        var scores = cwitObj.calculateScores(age, edu, sex, cwitVal);
        set_tscore(document.getElementById('t-score-' + cwitName), scores.tscore);
        document.getElementById('z-score-' + cwitName).value =  scores.zscore;
      }
    }

    function calculateDerivedMeasures(age, edu, sex){
      var cwit1raw = document.getElementById('raw-cwit1').value;
      var cwit2raw = document.getElementById('raw-cwit2').value;
      var cwit3raw = document.getElementById('raw-cwit3').value;
      var cwit4raw = document.getElementById('raw-cwit4').value;
      if (cwit3raw !== ''){
        var cwit3derived = cwit3Obj.calculateDerived(cwit1Obj, cwit2Obj, cwit3Obj, age, edu, sex, cwit1raw, cwit2raw, cwit3raw, cwit3raw);
        set_derived(document.getElementById('cwit3-1'), cwit3derived.CWIT_1);
        set_derived(document.getElementById('cwit3-2'), cwit3derived.CWIT_2);
        set_derived(document.getElementById('cwit3-1-2'), cwit3derived.CWIT_1_2);
      }
      if (cwit4raw !== ''){
        var cwit4derived = cwit4Obj.calculateDerived(cwit1Obj, cwit2Obj, cwit3Obj, age, edu, sex, cwit1raw, cwit2raw, cwit3raw, cwit4raw);
        set_derived(document.getElementById('cwit4-1'), cwit4derived.CWIT_1);
        set_derived(document.getElementById('cwit4-2'), cwit4derived.CWIT_2);
        set_derived(document.getElementById('cwit4-1-2'), cwit4derived.CWIT_1_2);
        set_derived(document.getElementById('cwit4-3'), cwit4derived.CWIT_3);
      }
    }

    /**
     * Calculates the tscore, zscore and cumulative percentage for all the CWIT tests. 
     */
    function calculate() {

      var age = parseInt(document.getElementById('age').value);
      var edu = parseInt(document.getElementById('edu').value);
      var sex = parseInt($('input[name="sex"]:checked').val());
      
      // iterate the cwitObject keys 
      for (var key in cwitTests) {
        calculateTest(age, edu, sex, key);
      }
      
      calculate_errors();

      calculateDerivedMeasures(age, edu, sex);
    }

    // ***** BULK UPLOAD *****
    const header = 'subject,age,education_years,sex,CWIT1,CWIT2,CWIT3,CWIT4,CWIT3_errors,CWIT4_errors,CWIT1_tscore,CWIT2_tscore,CWIT3_tscore,CWIT4_tscore,CWIT1_zscore,CWIT2_zscore,CWIT3_zscore,CWIT4_zscore,CWIT3_percentage,CWIT4_percentage,CWIT3_1,CWIT3_2,CWIT3_1_2,CWIT4_1,CWIT4_2,CWIT4_1_2,CWIT4_3\n';

    document.getElementById('fileForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent form submission
      loadFile(); // Call the loadFile function
    });

    /**
     * Shows or hide the spinner in the file process button.
     * @param {boolean} show - true to show the spinner, false to hide it
     */
    function showHideSpinner(show) {
      if (show) {
        $('#spinner').removeClass('visually-hidden');
      } else {
        $('#spinner').addClass('visually-hidden');
      }
    }

    /**
     * Loads the file and calls the processCSV function for each row.
     */
    function loadFile() {
      var input = document.getElementById('dataFile');
      // if there are files 
      if (input.files.length > 0) {
        // get the first file
        var file = input.files[0];
        // if the file is a csv file
        if (file.type == 'text/csv') {
          // read the file
          var reader = new FileReader();
          reader.onload = function() {
            var contents = reader.result;
            showHideSpinner(true);
            try {
              processCSV(contents);
            } catch (error) {
              console.log(error);
              alert('An error occured while processing the file. Please review the file and try again.');
            }
            showHideSpinner(false);        
          };
          reader.readAsText(file);
        } else {
          alert('Please select a CSV file');
        }
      } else {
        alert('Please select a file');
      }
    }

    /**
     * Processes the columns of the CSV file, creates the final data file and downloads it.
     * @param {string} contents - row string
     */
    function processCSV(contents) {
      var rows = contents.split('\n');
      var result = '';

      // Process each row (ignoring the header) and build the result string
      for (var i = 1; i < rows.length; i++) {
        var row = rows[i];
        // if the row is not empty
        if (row.length > 0) {
          // remove any whitespace from the row
          row = row.trim();
          // Split the row into columns
          var columns = row.split(',');
          // remove any whitespace from the columns
          
          // Process the columns
          var processedColumns = processColumns(columns);
          // Append the processed columns to the result string
          result += processedColumns.join(',') + '\n';
        }        
      }
      // set header 
      result = header + result;
      // Create a Blob object from the result string
      var blob = new Blob([result], { type: 'text/csv' });

      // Create a link element to download the CSV file
      var link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = 'CWIT_scores.csv';
      link.click();
      // remove the link element
      link.remove();
    }

    /**
     * Transforms different possible values for sex into 0 (male) or 1 (femal) integers.
     * @param {string} sex 
     */
    function parseSex(sex){
      if (sex == 'Male' || sex == 'male'){
        return 0
      } else if(sex == 'Female' || sex == 'female'){
        return 1
      } else if (sex == '0' || sex == '1'){
        return parseInt(sex);
      }
      else {
        return ''
      }
    }

    /**
     * Processes the columns of the CSV file, and returns the calculated scores for each CWIT test in the array, 
     * @param {string[]} columns - array of columns
     */
    function processColumns(columns) {
      var subject = columns[0];
      var age = columns[1];
      // if the age is not empty parse it to an integer
      if (age !== '') {
        age = parseInt(age);
      }
      var edu = columns[2];
      // if the education is not empty parse it to an integer
      if (edu !== '') {
        edu = parseInt(edu);
      }
      var sex = columns[3];
      sex = parseSex(sex)
      var cwit1 = columns[4];
      var cwit2 = columns[5];
      var cwit3 = columns[6];
      var cwit4 = columns[7];
      var cwit3_errors = columns[8];
      var cwit4_errors = columns[9];
      // if the raw scores are not empty calculate the z and tscores
      var cwit1_scores = cwit1 !== '' ? cwit1Obj.calculateScores(age, edu, sex, parseInt(cwit1)) : {tscore: '', zscore: ''};
      var cwit2_scores = cwit2 !== '' ? cwit2Obj.calculateScores(age, edu, sex, parseInt(cwit2)) : {tscore: '', zscore: ''};
      var cwit3_scores = cwit3 !== '' ? cwit3Obj.calculateScores(age, edu, sex, parseInt(cwit3)) : {tscore: '', zscore: ''};
      var cwit4_scores = cwit4 !== '' ? cwit4Obj.calculateScores(age, edu, sex, parseInt(cwit4)) : {tscore: '', zscore: ''};
      var CWIT3_percentage = cwit3_errors !== '' ? cwit3Obj.get_percentage(cwit3_errors) : '';
      var CWIT4_percentage = cwit4_errors !== '' ? cwit4Obj.get_percentage(cwit4_errors) : '';
      // calculate the derived measures for CWIT3 and CWIT4
      var cwit3_derived = cwit3 !== '' ? cwit3Obj.calculateDerived(cwit1Obj, cwit2Obj, cwit3Obj, age, edu, sex, cwit1, cwit2, cwit3, cwit3) : {CWIT_1: '', CWIT_2: '', CWIT_1_2: ''};
      var cwit4_derived = cwit4 !== '' ? cwit4Obj.calculateDerived(cwit1Obj, cwit2Obj, cwit3Obj, age, edu, sex, cwit1, cwit2, cwit3, cwit4) : {CWIT_1: '', CWIT_2: '', CWIT_1_2: '', CWIT_3: ''};

      columns[10] = cwit1_scores.tscore;
      columns[11] = cwit2_scores.tscore;
      columns[12] = cwit3_scores.tscore;
      columns[13] = cwit4_scores.tscore;
      columns[14] = cwit1_scores.zscore;
      columns[15] = cwit2_scores.zscore;
      columns[16] = cwit3_scores.zscore;
      columns[17] = cwit4_scores.zscore;
      columns[18] = CWIT3_percentage;
      columns[19] = CWIT4_percentage;
      columns[20] = cwit3_derived.CWIT_1;
      columns[21] = cwit3_derived.CWIT_2;
      columns[22] = cwit3_derived.CWIT_1_2;
      columns[23] = cwit4_derived.CWIT_1;
      columns[24] = cwit4_derived.CWIT_2;
      columns[25] = cwit4_derived.CWIT_1_2;
      columns[26] = cwit4_derived.CWIT_3;
      
      return columns;
    }

  </script>

  <script>
  window.onload = function() {
    var csvContent = "subject,age,education_years,sex,CWIT1,CWIT2,CWIT3,CWIT4,CWIT3_errors,CWIT4_errors\n"; // CSV header
    var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    var url = URL.createObjectURL(blob);
    var link = document.getElementById("download-link");
    link.setAttribute("href", url);
    link.setAttribute("download", "cwit_template.csv");
  }
  </script>

</body>

</html>
