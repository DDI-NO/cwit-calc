<!doctype html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>CWIT Norm Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <style media="screen">
    .calc {
      padding: 25px;
    }

    .measures {
      margin-bottom: 25px;
    }

  </style>  

</head>

<body class="bg-light">
  <div class="container">
    <div class="py-4 text-center">

      <h2>CWIT Norm Calculator</h2>

    </div>

    <div class="border rounded">

      <form class="calc" action="#" id="calc">
        <div class="measures">
          <!-- Demographics -->
          <div class="form-group row">
            <label for="age1" class="col-sm-2 col-form-label">Age</label>
            <div class="col-sm-4 col-4">
              <input type="number" class="form-control form-control-sm" name="age" id="age" min="20" max="85" placeholder="20 - 85" required />
            </div>
          </div>
          <div class="form-group row">
            <label for="years1" class="col-sm-2 col-form-label">Years of education</label>
            <div class="col-sm-4">
              <input type="number" class="form-control form-control-sm" name="edu" id="edu" min="7" max="23" placeholder="7 - 23" required>
            </div>
          </div>
          <div class="form-group row">
            <label for="gender" class="col-sm-2 col-form-label">Sex</label>
            <div class="col-sm-4">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sex" id="radio-male" value="0" checked>
                <label class="form-check-label" for="radio-male">
                  Male
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sex" id="radio-female" value="1">
                <label class="form-check-label" for="radio-female">
                  Female
                </label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group row">
          <div class="col-sm-10 measures">
            <button type="submit" class="btn btn-primary">Calculate</button>
          </div>
        </div>


        <div class="measures">
          <h5>Main measures</h5>
          <div class="form-group row">
            <div class="col-sm-1 col-3">
            </div>
            <label for="raw-score-a" class="col-sm-2 col-3 col-form-label">Raw score</label>
            <label for="raw-score-a" class="col-sm-2 col-3 col-form-label">Z-Score</label>
            <label for="raw-score-a" class="col-sm-2 col-3 col-form-label">T-Score</label>
          </div>

          <div class="form-group row">
            <label for="raw-score-a" class="col-sm-1 col-3 col-form-label">CWIT 1</label>
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm raw" data-cwit="cwit1" id="raw-cwit1">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm zscore" id="z-score-cwit1" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm tscore" id="t-score-cwit1" tabindex="-1" readonly>
            </div>
          </div>

          <div class="form-group row">
            <label for="raw-score-a" class="col-sm-1 col-3 col-form-label">CWIT 2</label>
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm raw" id="raw-cwit2" data-cwit="cwit2">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm zscore" id="z-score-cwit2" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm tscore" id="t-score-cwit2" tabindex="-1" readonly>
            </div>
          </div>

          <div class="form-group row">
            <label for="raw-score-a" class="col-sm-1 col-3 col-form-label">CWIT 3</label>
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm raw" id="raw-cwit3" data-cwit="cwit3">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm zscore" id="z-score-cwit3" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm tscore" id="t-score-cwit3" tabindex="-1" readonly>
            </div>
            
          </div>
          <div class="form-group row">
            <label for="raw-score-a" class="col-sm-1 col-3 col-form-label">CWIT 4</label>
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm raw" id="raw-cwit4" data-cwit="cwit4">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm zscore" id="z-score-cwit4" tabindex="-1" readonly>
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm tscore" id="t-score-cwit4" tabindex="-1" readonly>
            </div>
            
          </div>
        </div>

        <div class="measures" id="error-container">
          <h5>Errors</h5>
          <div class="form-group row">
            <div class="col-sm-1 col-3">
            </div>
            <label for="raw-score-a" class="col-sm-2 col-3 col-form-label">No. of errors</label>
            <label for="raw-score-a" class="col-sm-2 col-3 col-form-label">Cumulative %</label>
          </div>
          <div class="form-group row">
            <label for="raw-score-a" class="col-sm-1 col-3 col-form-label">CWIT 3</label>
            
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm error" id="error-cwit3">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm" id="percentage-cwit3" tabindex="-1" readonly>
            </div>
          </div>
          <div class="form-group row">
            <label for="raw-score-a" class="col-sm-1 col-3 col-form-label">CWIT 4</label>
            
            <div class="col-sm-2 col-3">
              <input type="number" class="form-control form-control-sm error" id="error-cwit4">
            </div>
            <div class="col-sm-2 col-3">
              <input type="text" class="form-control form-control-sm" id="percentage-cwit4" tabindex="-1" readonly>
            </div>
          </div>
        </div>
      </form>
  
      
    
    </div>

    <div class="border rounded" style="margin-top: 20px;">
      <form id="fileForm" class="calc">
        <div class="measures">
          <h5>Bulk processing</h5> <i class="fa-regular fa-circle-question"></i>
          <div class="form-group row">
            <label for="formFile" class="form-label">CSV data file</label>
            <div class="col-sm-6 col-3">
              <input class="form-control" type="file" id="dataFile">
            </div>
          </div>

          <div class="form-group row" style="margin-top: 10px;">
            <div class="col-sm-10">
              <button type="submit" class="btn btn-primary" value="Process file">Process file</button>
            </div>
          </div>
        </div>

      </form>
    </div>
    
    <footer class="container py-5">
      <small>Created by the Dementia Disease Initiation (DDI) project; No guarantee or liability implied.<br>
        Supplement of <em>Espenes et al (2023). Regression‚Äêbased normative data for the D-KEFS Color-Word Interference Test in Norwegian adults ages 20 to 85</em></small>
    </footer>

  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script type="text/javascript">

    document.getElementById('fileForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent form submission
      loadFile(); // Call the loadFile function
    });

    function loadFile() {
      var input = document.getElementById('dataFile');
      var file = input.files[0];

      var reader = new FileReader();
      reader.onload = function() {
        var contents = reader.result;
        processCSV(contents);
      };
      reader.readAsText(file);
    }

    function processCSV(contents) {
      var rows = contents.split('\n');
      var result = '';

      // Process each row and build the result string
      for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        // if the row is not empty
        if (row.length > 0) {
          // Split the row into columns
          var columns = row.split(',');
          // Do something with the columns
          var processedColumns = processColumns(columns);
          // Append the processed columns to the result string
          result += processedColumns.join(',') + '\n';
        }        
      }

      // Create a Blob object from the result string
      var blob = new Blob([result], { type: 'text/csv' });

      // Create a link element to download the CSV file
      var link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = 'processed_data.csv';
      link.click();
      // remove the link element
      link.remove();
    }

    function processColumns(columns) {
      // Do something with the columns
      // age,education_years,sex,CWIT1,CWIT2,CWIT3,CWIT4,CWIT3_errors,CWIT4_errors
      var age = columns[1];
      var edu = columns[2];
      var sex = columns[3];
      var cwit1 = columns[4];
      var cwit2 = columns[5];
      var cwit3 = columns[6];
      var cwit4 = columns[7];
      var cwit3_errors = columns[8];
      var cwit4_errors = columns[9];

      return columns;
    }

    $('#calc').submit(function() {
      calculate();
      return false;
    });

    const t_score_min = 20;
    const t_score_max = 80;
    const mean_age = 46.165183;
    const mean_edu = 15.456973;

    class CWITTest{
      constructor (intercept, coefs, sd, scalingTable, percentageTable) {
        this.intercept = intercept;
        this.sd = sd;
        this.coefs = coefs;
        this.scalingTable = scalingTable;
        this.percentageTable = percentageTable;
      }

      calculateScores(age, edu, sex, test_raw){
        var age_centered = age - mean_age;
        var age_centered_2 = age_centered * age_centered;
        var edu_centered = edu - mean_edu;

        var b_age = this.coefs.age;
        var b_age_2 = this.coefs.age2;
        var b_edu = this.coefs.edu;
        var b_sex = this.coefs.sex;

        // age coefficient is common to all tests
        var coefSum = (b_age * age_centered) + (b_age_2 * age_centered_2);
        // if edu in coefs is not undefined add to the sum
        if (b_edu) {
          coefSum += b_edu * edu_centered;
        }
        // if b_sex is not undefined add to the sum
        if (b_sex) {
          coefSum += b_sex * sex;
        }

        // final predicted score
        var scaled = scaleValue(test_raw, this.scalingTable);
        var predicted = this.intercept + coefSum;
        var cwit1Dif = scaled - predicted;
        var zscore = (scaled - predicted) / this.sd;
        var tscore = Math.max(t_score_min, Math.min(t_score_max, zscore * 10 + 50));

        return {
          'zscore' : Math.round(zscore),
          'tscore' : Math.round(tscore)
        }
      }

      get_percentage(errors){

        // if this.percentages is undefined return 100
        if (!this.percentageTable) {
          return undefined;
        }

        var percentage = 100;
        var i = 0;

        while (i < this.percentageTable.length - 1 && errors != this.percentageTable[i][0]) {
          i++;
          percentage = this.percentageTable[i][1];
        }
        return percentage;
      }

    }

    
    // regression data structures
    var regression = {
      'mean_age' : 46.165183,
      'mean_edu' : 15.456973,
      'cwit1': {
        'intercept' :  9.863261,
        'demographic_coefs' : {
                            "age" :  -0.048884,
                            "age2" :  -0.001047,
                            "sex" :  0.824552
                          },
        "sd" :  2.774862,
        'scalingTable' : [
                          ['>=56', 1], //>= 56
                          ['48-55', 2],
                          ['46-47', 3],
                          ['42-45', 4],
                          ['40-41', 5],
                          ['37-39', 6],
                          ['35-36', 7],
                          ['33-34', 8],
                          ['31-32', 9],
                          ['29-30', 10],
                          ['27-28', 11],
                          [26, 12],
                          [25, 13],
                          ['23-24', 14],
                          [22, 15],
                          [21, 16],
                          [20, 17],
                          [19, 18],
                          ['<=18', 19], // <= 18
                        ]
      },

      'cwit2': {
        'intercept': 10.2171656,
        'demographic_coefs' : {
                                'age': -0.0185594,
                                "age2" :  -0.0009477
                              },
        'sd': 2.7966,
        'scalingTable' : [
                          ['>=52', 1], // ‚â•52
                          ['37-51', 2],
                          ['34-36', 3],
                          ['31-33', 4],
                          ['28-30', 5],
                          [27, 6],
                          ['25-26', 7],
                          [24, 8],
                          [23, 9],
                          ['21-22', 10],
                          [20, 11],
                          [19, 12],
                          [18, 13],
                          [17, 14],
                          [16, 15],
                          [15, 16],
                          ['<=14', 18], // ‚â§14
                        ]
      },

      'cwit3': {
        'intercept': 10.1824414,  
        'demographic_coefs' : {
                              'age': -0.0725760,  
                              'age2': -0.0012170,  
                              'sex': 0.4544109,
                              'edu': 0.0777976
                            },
        'sd': 2.545823, 
        'scalingTable' : [
                          ['>=130', 1], // ‚â•130
                          ['114-129', 2],
                          ['99-113', 3],
                          ['85-98', 4],
                          ['77-84', 5],
                          ['69-76', 6],
                          ['63-68', 7],
                          ['58-62', 8],
                          ['53-57', 9],
                          ['49-52', 10],
                          ['45-48', 11],
                          ['42-44', 12],
                          ['40-41', 13],
                          ['37-39', 14],
                          ['35-36', 15],
                          ['33-34', 16],
                          ['31-32', 17],
                          ['27-30', 18],
                          ['<=26', 19], // ‚â§26
                        ],
        'errors' : [
                    [0, 100],
                    [1, 51.4],
                    [2, 23.2],
                    [3, 11.1],
                    [4, 5.2],
                    [5, 2.8],
                    [6, 1.2],
                    [7, 0.5],
                    [8, 0.4],
                    [9, 0.2],
                    [10, 0.2],
                    [11, 0.1]
                  ]
      },

      'cwit4': {
        'intercept': 10.5608373, 
        'demographic_coefs' : {
                              'age': -0.0629144,
                              'age2': -0.0015815,
                              'edu': 0.0981283
                            },
        'sd': 2.573627, 
        'scalingTable' : [
                          ['>=168', 1], 
                          ['133-167', 2],
                          ['117-132', 3],
                          ['101-116', 4],
                          ['88-100', 5],
                          ['78-87', 6],
                          ['71-77', 7],
                          ['65-70', 8],
                          ['60-64', 9],
                          ['55-59', 10],
                          ['51-54', 11],
                          ['48-50', 12],
                          ['45-47', 13],
                          ['42-44', 14],
                          ['39-41', 15],
                          ['37-38', 16],
                          ['34-36', 17],
                          ['31-33', 18],
                          ['<=30', 19], 
                        ],
        'errors' : [
                    [0, 100],
                    [1, 55.4],
                    [2, 26.5],
                    [3, 12.9],
                    [4, 6.3],
                    [5, 3.2],
                    [6, 1.5],
                    [7, 1.1],
                    [8, 0.6],
                    [9, 0.6],
                    [10, 0.6],
                    [11, 0.2]
                  ]                
      },      
    }

    // instantiate CWITTest objects
    const cwit1Obj = new CWITTest(regression.cwit1.intercept, regression.cwit1.demographic_coefs, regression.cwit1.sd, regression.cwit1.scalingTable);
    const cwit2Obj = new CWITTest(regression.cwit2.intercept, regression.cwit2.demographic_coefs, regression.cwit2.sd, regression.cwit2.scalingTable);
    const cwit3Obj = new CWITTest(regression.cwit3.intercept, regression.cwit3.demographic_coefs, regression.cwit3.sd, regression.cwit3.scalingTable, regression.cwit3.errors);
    const cwit4Obj = new CWITTest(regression.cwit4.intercept, regression.cwit4.demographic_coefs, regression.cwit4.sd, regression.cwit4.scalingTable, regression.cwit4.errors);
    // create an object to hold all the CWITTest objects
    const cwitTests = {
      'cwit1': cwit1Obj,
      'cwit2': cwit2Obj,
      'cwit3': cwit3Obj,
      'cwit4': cwit4Obj
    }

    /**
     * This function a escaling entry and a rawValue and returns true if the rawValue is in the range of the entry
     * @param {Array} entry - an array of two elements, the first is the range and the second is the value to return if the rawValue is in the range
     * @param {Number} rawValue - the raw value to be evaluated
     * @return {Boolean} - true if the rawValue is in the range of the entry
     */
    function evaluateScalingEntry(entry, rawValue){
      if (typeof entry[0] === 'number') {
        return rawValue == entry[0];
      } else if (typeof entry[0] === 'string'){
        var test = entry[0];
        // if there is a - in the string then it is a range
        if (test.indexOf('-') > -1) {
          var range = test.split('-');
          return rawValue >= range[0] && rawValue <= range[1];
        } 
        // if there is a '>=' in the string then it is the upper cutoff
        else if (test.indexOf('>=') > -1) {
          var top = test.split('>=')[1];
          return rawValue >= top;
        }
        // if there is a '<=' in the string then it is the lower cutoff
        else if (test.indexOf('<=') > -1) {
          var bottom = test.split('<=')[1];
          return rawValue <= bottom;
        }
      }
    }

    /**
     * This function takes in a raw value and a scaling table and returns the scaled value
     * 
     * @param {number} rawValue - the raw value to be scaled
     * @param {array} scalingTable - the scaling table to use
     * @returns {number} - the scaled value
     */
    function scaleValue(value, lookupTable) {
      // Find the index of the input value in the lookup table
      var i = 0;
      while (i < lookupTable.length - 1 && !evaluateScalingEntry(lookupTable[i], value)) {
        i++;
      }
      var scaled = lookupTable[i][1];
      return scaled;
    }

    /**
     * This function takes the demographic coefs of the test and returns the sum of the product of the demographic data and the regression coefficients
     * @param {Object} demographic - the demographic data
     * @return {Number} - the sum of the product of the demographic data and the regression coefficients
     */
    function sumProduct(demographic) {
      var sum = 0;
      for (var key in demographic) {
        if (demographic.hasOwnProperty(key)) {
          var coef = demographic[key];
          // strip any number from the key string
          var element_key = key.replace(/\d+/g, '');
          var elem = document.getElementsByName(element_key)[0];

          if(elem !== undefined){
            var elemVal = parseInt(elem.value);
            // if the item key is not sex, then it is an age or education item
            if(key != 'sex'){
              mean = regression['mean_' + element_key];
              // mean center the value
              elemVal = elemVal - mean;
              if(key == 'age2'){
                // in the case of age2, it is the square the value
                elemVal = elemVal * elemVal;
              }
            } else{
              // using jquery, get the value of the radio button with the same name attribute as the key
              elemVal = $('input[name="' + key + '"]:checked').val();


            }
            
            sum += coef * elemVal;
            
          }
          
        }
      }
      return sum;
    }

    function calculate_tscore(elem) {
      if (this.value !== '') {
        var value = parseInt(this.value);
        var cwit = $(this).data('cwit');
        var cwit_coefs = regression[cwit];
        var demographic = cwit_coefs.demographic_coefs;
        var scalingTable = cwit_coefs.scalingTable;
        var scaledScore = scaleValue(value, scalingTable);
        // iterate over demographic coefficients, for each item get the value of the HTML element having the same name attribute. 
        // to obtain the sum the product of each item value and the retrieved HTML element value.
        var sum = sumProduct(demographic);
        // predicted value by regression
        var predicted = cwit_coefs.intercept + sum;
        // difference between scaled score and predicted value
        var dif = scaledScore - predicted;
        // z-score and t-score
        var zscore = (scaledScore - predicted) / cwit_coefs.sd;
        var tscore = Math.max(t_score_min, Math.min(t_score_max, Math.round(zscore * 10 + 50)));
        console.log(cwit + '==> predicted=' + predicted + ' dif='+dif + ' zscore='+zscore + ' tscore='+tscore);

        
        $('#t-score-' + cwit).val(tscore);
      }
    }   

    function set_tscore(element, tscore) {
      if (!Number.isNaN(tscore)) {
        // if tscore == 80 add >= to the value
        if (tscore == 80) {
          tscore = '‚â• 80';
        }
        // if tscore == 20 add <= to the value
        if (tscore == 20) {
          tscore = '‚â§ 20';
        }
        $(element).val(tscore);
      } else {
        $(element).val('');
      }
    }

    function get_percentage(raw, percentages){
      var error = 100;
      var i = 0;

      while (i < percentages.length - 1 && raw != percentages[i][0]) {
        i++;
        error = percentages[i][1];
      }
      return error;
    }

    function calculate_errors(){
      tests = ['3', '4'];
      for(var i = 0; i < tests.length; i++){
        var test = tests[i];
        var cwitName = 'cwit' + test;
        var cwitObj = cwitTests[cwitName];
        // get the element value
        var elem = document.getElementById('error-cwit' + test);
        if (elem.value !== '') {
          var elemVal = parseInt(elem.value);
          // var errors = regression['cwit' + test].errors;
          // var error = get_percentage(elemVal, errors);
          var error = cwitObj.get_percentage(elemVal);
          $('#percentage-cwit' + test).val(error);
        }
      }
    }

    function calculateCWIT1Tscore() {
      // CWIT 1 
      var cwit1 = document.getElementById('raw-cwit1');
      var cwit_coefs = regression['cwit1'];
      var demographic_coefs = cwit_coefs.demographic_coefs;
      var scalingTable = cwit_coefs.scalingTable;
      if (cwit1.value !== '') {
        var age_centered = document.getElementById('age').value - regression.mean_age;
        var age_centered_2 = age_centered * age_centered;
        var edu_centered = document.getElementById('edu').value - regression.mean_edu;
        var sex = parseInt($('input[name="sex"]:checked').val());

        var b_age = demographic_coefs.age;
        var b_age_2 = demographic_coefs.age2;
        var b_sex = demographic_coefs.sex;
        var sd = cwit_coefs.sd;

        var cwit1Val = parseInt(cwit1.value);
        var cwit1SD = cwit_coefs.sd;
        var cwit1Scaled = scaleValue(cwit1Val, scalingTable);
        var cwit1Predicted = cwit_coefs.intercept + (age_centered * demographic_coefs.age) + (age_centered_2 * b_age_2) + (sex * demographic_coefs.sex);
        var cwit1Dif = cwit1Scaled - cwit1Predicted;
        var cwit1Zscore = (cwit1Scaled - cwit1Predicted) / sd;
        var cwit1Tscore = Math.max(t_score_min, Math.min(t_score_max, cwit1Zscore * 10 + 50));
        set_tscore(document.getElementById('t-score-cwit1'), cwit1Tscore);
        
        
      }
    }

    function calculateCWIT2Tscore(){
      // CWIT 2
      var cwit2 = document.getElementById('raw-cwit2');
      
      if (cwit2.value !== ''){
        var cwit_coefs = regression['cwit2'];
        var demographic_coefs = cwit_coefs.demographic_coefs;
        var scalingTable = cwit_coefs.scalingTable;
        var age_centered = document.getElementById('age').value - regression.mean_age;
        var age_centered_2 = age_centered * age_centered;
        

        var b_age = demographic_coefs.age;
        var b_age_2 = demographic_coefs.age2;
        var sd = cwit_coefs.sd;

        var cwit2Val = parseInt(cwit2.value);
        var cwit2SD = cwit_coefs.sd;
        var cwit2Scaled = scaleValue(cwit2Val, scalingTable);
        var cwit2Predicted = cwit_coefs.intercept + (age_centered * b_age) + (age_centered_2 * b_age_2);
        var cwit2Dif = cwit2Scaled - cwit2Predicted;
        var cwit2Zscore = (cwit2Scaled - cwit2Predicted) / sd;
        var cwit2Tscore = Math.max(t_score_min, Math.min(t_score_max, cwit2Zscore * 10 + 50));
        set_tscore(document.getElementById('t-score-cwit2'), cwit2Tscore);
      }
    }

    function calculateCWIT3Tscore(){
      // CWIT 3
      var cwit3 = document.getElementById('raw-cwit3');
      
      if (cwit3.value !== ''){
        var cwit_coefs = regression['cwit3'];
        var demographic_coefs = cwit_coefs.demographic_coefs;
        var scalingTable = cwit_coefs.scalingTable;
        var age_centered = document.getElementById('age').value - regression.mean_age;
        var age_centered_2 = age_centered * age_centered;
        var edu_centered = document.getElementById('edu').value - regression.mean_edu;
        var sex = parseInt($('input[name="sex"]:checked').val());

        var b_age = demographic_coefs.age;
        var b_age_2 = demographic_coefs.age2;
        var b_sex = demographic_coefs.sex;
        var b_edu = demographic_coefs.edu;

        var sd = cwit_coefs.sd;
        var cwit3Val = parseInt(cwit3.value);
        var cwit3SD = cwit_coefs.sd;
        var cwit3Scaled = scaleValue(cwit3Val, scalingTable);
        var cwit3Predicted = cwit_coefs.intercept + (age_centered * b_age) + (age_centered_2 * b_age_2) + (sex * b_sex) + (edu_centered * b_edu);
        var cwit3Dif = cwit3Scaled - cwit3Predicted;
        var cwit3Zscore = (cwit3Scaled - cwit3Predicted) / sd;
        var cwit3Tscore = Math.max(t_score_min, Math.min(t_score_max, cwit3Zscore * 10 + 50));
        set_tscore(document.getElementById('t-score-cwit3'), cwit3Tscore);
      }
    }

    function calculateCWIT4Tscore(){
      // CWIT 4
      var cwit4 = document.getElementById('raw-cwit4');
      
      if (cwit4.value !== ''){
        var cwit_coefs = regression['cwit4'];
        var demographic_coefs = cwit_coefs.demographic_coefs;
        var scalingTable = cwit_coefs.scalingTable;
        var age_centered = document.getElementById('age').value - regression.mean_age;
        var age_centered_2 = age_centered * age_centered;
        var edu_centered = document.getElementById('edu').value - regression.mean_edu;

        var b_age = demographic_coefs.age;
        var b_age_2 = demographic_coefs.age2;
        var b_edu = demographic_coefs.edu;
        var sd = cwit_coefs.sd;

        var cwit4Val = parseInt(cwit4.value);
        var cwit4SD = cwit_coefs.sd;
        var cwit4Scaled = scaleValue(cwit4Val, scalingTable);
        var cwit4Predicted = cwit_coefs.intercept + (age_centered * b_age) + (age_centered_2 * b_age_2) + (edu_centered * b_edu);
        var cwit4Dif = cwit4Scaled - cwit4Predicted;
        var cwit4Zscore = (cwit4Scaled - cwit4Predicted) / sd;
        var cwit4Tscore = Math.max(t_score_min, Math.min(t_score_max, cwit4Zscore * 10 + 50));
        set_tscore(document.getElementById('t-score-cwit4'), cwit4Tscore);
      }
    }

   

    function calculateTest(age, edu, sex, cwitName) {
        var cwit = document.getElementById('raw-' + cwitName);
        
        var cwitObj = cwitTests[cwitName];
        if (cwit.value !== ''){
          var cwitVal = parseInt(cwit.value);
          var scores = cwitObj.calculateScores(age, edu, sex, cwitVal);
          set_tscore(document.getElementById('t-score-' + cwitName), scores.tscore);
          document.getElementById('z-score-' + cwitName).value =  scores.zscore;
        }
      }

    function calculate() {
      // $('.raw').each(calculate_tscore);
      var age = parseInt(document.getElementById('age').value);
      var edu = parseInt(document.getElementById('edu').value);
      var sex = parseInt($('input[name="sex"]:checked').val());
      
      // iterate the cwitObject keys 
      for (var key in cwitTests) {
        calculateTest(age, edu, sex, key);
      }
      
      calculate_errors();
    }
  </script>
</body>

</html>
